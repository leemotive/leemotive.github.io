---
title: asyncå’Œawaitæ˜¯ä»€ä¹ˆ
author: æŸšå­816
toc: true
comment: true
date: 2024-02-06 22:31:27
tags: 
  - async/await
  - js
  - generator
category: å‰ç«¯
cover: ./cover.jpeg
---



è¿‘äº›å¹´åœ¨å‰ç«¯é¡¹ç›®ä¸­æ¶‰åŠåˆ°å¼‚æ­¥ä»£ç åŸºæœ¬éƒ½èƒ½çœ‹åˆ° `async/await` çš„èº«å½±ï¼Œä»–çš„æœ€å¤§çš„ä½œç”¨å°±æ˜¯èƒ½å¤Ÿä¸­æ–­å½“å‰ä»£ç çš„è¿è¡Œï¼Œå½“ `await` åé¢çš„ Promise å¯¹è±¡çš„çŠ¶æ€å˜æˆ fulfilled çš„æ—¶å€™æ‰ç»§ç»­æ¥ç€æ‰§è¡Œåé¢çš„ä»£ç ã€‚è¿™å°±è®©ä¹‹å‰ä¸€äº›ä¼ é€’å›è°ƒå‡½æ•°çš„å†™æ³•å˜æˆäº†åŒæ­¥çš„ä»£ç æ–¹å¼ã€‚é‚£ä¹ˆ async/await æ˜¯æ€ä¹ˆå›äº‹å‘¢



## å›è°ƒå¼å†™æ³•

ä¸€å¼€å§‹å¼‚æ­¥çš„å†™æ³•å…¨é å›è°ƒå‡½æ•°åµŒå¥—å›è°ƒå‡½æ•°æ¯”å¦‚ä¸‹é¢çš„ä»£ç 

```js
$.ajax({
  success() {
    $.ajax({
      success() {}
    })
  }
})
```

åœ¨ä¸€äº›æœ‰ä¸€å®šå¹´å¤´çš„é¡¹ç›®é‡Œï¼Œç±»ä¼¼çš„ä»£ç ä¸åœ¨å°‘æ•°ï¼Œéå¸¸å®¹æ˜“å½¢æˆå›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä»£ç åµŒå¥—å±‚æ¬¡æ·±ç¼©è¿›å¤§ï¼Œå¯¼è‡´ç»“æ„æ··ä¹±å¯è¯»æ€§é™ä½ã€‚å½“ç„¶å¦‚æœä½ èƒ½åŠ›å¥½ï¼ŒæŠŠä¸€äº›å›è°ƒå‡½æ•°å°è£…æˆç‹¬çš„å‡½æ•°ï¼Œå¯èƒ½ä¼šæå‡ä¸€ç‚¹ä»£ç è´¨é‡ï¼Œä½†æ˜¯é¿å…ä¸äº†å›è°ƒå‡½æ•°è¢«ä¼ é€’æ¥ä¼ é€’å»ï¼Œæœ€åéƒ½ä¸çŸ¥é“ä¼ é€’è¿›å»çš„å‡½æ•°ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨



## Promise

éšç€çš„ Promise çš„å‡ºç°ï¼Œå›è°ƒåœ°ç‹±çš„é—®é¢˜æœ‰çš„ç¼“è§£ï¼Œå› ä¸ºå®ƒå¸¦æ¥ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼

```javascript
fetch(url).then(handle1).then(handle2).then(handle3)
```

ä¸Šé¢çš„ä»£ç å®ç°äº†åœ¨è¯·æ±‚å®Œæˆåï¼ŒæŒ‰é¡ºåºæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ¯ä¸ªå›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆåè¿”å›ä¸€ä¸ªç»“æœï¼Œè¿™ä¸ªç»“æœä¼šè¢«ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå›è°ƒå‡½æ•°

è¿™å°±æŠŠå¤šä¸ªå›è°ƒå‡½æ•°æŒ‰ä¸€å®šçš„é¡ºåºé“¾èµ·æ¥äº†ï¼Œå½“é¡µé¢çš„å›è°ƒå‡½æ•°æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç»“æœæ—¶æ‰ä¼šè§¦å‘ä¸‹ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ ·çš„ç»“æ„æ˜¯æœ‰é¡ºåºçš„ï¼Œæ‰€ä»¥æ„Ÿè§‰ä¸Šå°±æ›´æœ‰æ¡ç†äº†ã€‚ç„¶åæˆ‘ä»¬ä»£ç å¹¶ä¸æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•å¸¸è€ƒé—®é¢˜ï¼Œç»™ä½ ä¸€ä¸ªå‡½æ•°ï¼Œé‡Œé¢ä¸€å † setTimeout Promise console ç„¶åé—®ä½ console çš„è¾“å‡ºé¡ºåº



## async/await

è¿™å°±å†è¿›ä¸€æ­¥äº†ï¼ŒæŠŠ promise çš„è¿™ç§å¼‚æ­¥å›è°ƒçš„æ–¹å¼åŒæ­¥çš„æ–¹å¼æ¥ç¼–å†™ï¼Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–ä»£ç ç»“æ„ï¼Œå¢å¼ºä»£ç å¯è¯»æ€§

```javascript
async function main(url) {
  let res = await fetch(url)
  res = await handle1(res)
  res = handle2(res)
  return handle3(res)
}

```

è¿™æ ·åœ¨mainæ–¹æ³•å†…éƒ¨å°†ä»¥åŒæ­¥çš„æ–¹å¼æ¥æ‰§è¡Œä»£ç ï¼Œè™½ç„¶ js æ‰§è¡Œä»£ç è¿˜æ˜¯æœ‰å¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯ä»ä»£ç ä¸Šçœ‹ï¼Œåé¢çš„å¤„ç†å‡½æ•°ä¸€å®šæ˜¯åœ¨å‰é¢çš„å¤„ç†å‡½æ•°å®Œæˆä¹‹åæ‰ä¼šæ‰§è¡Œã€‚



é‚£ async/await æ˜¯ä»€ä¹ˆå‘¢ï¼Œå®ƒå…¶å®å°±ä¸€ç§è¯­æ³•ç³–ã€‚æ˜¯ç”Ÿæˆå™¨ `Generator` çš„è¯­æ³•ç³–ï¼Œå…¶å® async/await æœ€å¤§çš„ä½œç”¨å°±æ˜¯ä¸­æ–­æ–¹æ³•æ‰§è¡Œï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºæ¢å¤æ‰§è¡Œã€‚è€Œåœ¨ js é‡Œè¿™æ­£æ˜¯ç”Ÿæˆå™¨çš„åŠŸèƒ½ï¼Œé‚£ä»€ä¹ˆåˆæ˜¯ç”Ÿæˆå™¨å‘¢ï¼Œå…¶å®å°±æ˜¯é€šè¿‡æ˜Ÿå·æ ‡è®°çš„å‡½æ•°

å…¶å®ç”Ÿæˆå™¨æ—©åœ¨2011å¹´å°±æœ‰äº†

![](./generator.jpeg)



è¿™æ˜¯æˆ‘ 2012 ä¹°çš„ **JavaScript æƒå¨æŒ‡å—** é‡Œçš„ä¸€ä¸ªæˆªå›¾ï¼Œè¿™æœ¬ä¹¦å½“æ—¶ç¿»è¯‘æ˜¯ç”Ÿæˆå™¨ï¼Œå’Œæˆªå›¾é‡Œä¸Šé¢çš„ let è¯­å¥ä¸€æ ·ï¼Œyield è¯­å¥ä¹Ÿæ˜¯1.7æ–°å¢ï¼Œå½“æ—¶åªé€‚ç”¨äºFirefox2.0åŠæ›´é«˜ç‰ˆæœ¬æµè§ˆå™¨ã€‚å¯èƒ½å½“æ—¶è¿™äº›åªæ˜¯ææ¡ˆå§ã€‚è¯­æ³•è¿˜ä¸ç¨³å®šï¼Œå½“æ—¶å®šä¹‰ Generator å‡½æ•°éƒ½ä¸éœ€è¦æ˜Ÿå·ã€‚è€Œä¸”è¿˜æœ‰ let è¯­å¥ï¼Œå¦‚ä»Š let å·²ç»æ˜¯ä½œä¸ºå£°æ˜å˜é‡çš„å…³é”®è¿™äº†ã€‚å½“å¹´çœ‹åˆ°è¿™ç« èŠ‚çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€å¤´é›¾æ°´ã€‚å®Œå…¨ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿çš„åº”ç”¨åœºæ™¯ã€‚ç›´åˆ°åæ¥ async/await çš„å…´èµ·



## è‡ªè¡ŒåŒ…è£…

æ—¢ç„¶ async/await æ˜¯è¯­æ³•ç³–ï¼Œé‚£èƒ½ä¸èƒ½è‡ªå·±å°è£…ä¸€ä¸ªå‘¢ï¼Œå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚ç›´æ¥ä¸Šä»£ç 

```javascript
function generatorToAsync(executor) {
  // è¿™æ˜¯å…¶å®å¯ä»¥åˆ¤æ–­ä¸€ä¸‹executoråº”è¯¥æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œå‡½æ•°
  function handler(gen, res, resolve, reject) {
    if (res.done) {
      return resolve(res.value);
    }
    if (typeof res.value.then === "function") {
      res.value.then((r) => gen.next(r)).then((r) => handler(gen, r, resolve, reject), reject);
    } else {
      Promise.resolve(res.value).then((r) => handler(gen, r, resolve, reject));
    }
  }

  return function (...args) {
    const { promise, resolve, reject } = Promise.withResolvers();
    try {
      const gen = executor.apply(this, args);
      if (Object.prototype.toString.call(executor) !== "[object Generator]") {
        resolve(gen)
      } else {
        handler(gen, gen.next(), resolve, reject);
      }
    } catch (err) {
      reject(err);
    }
    return promise;
  };
}
```

ä»£ç ä¸­çš„ `Promise.withResolvers` æ˜¯ ECMAScript<sup>Â®</sup>2024 ä¸­å¼•å…¥çš„æ–°åŠŸèƒ½ï¼Œæœ‰ä¸äº†è§£çš„å¯ä»¥å‚è€ƒ[Promiseè¿™ä¸ªæ–°apiæœ‰ç‚¹é¦™](https://juejin.cn/post/7310038698338844735) 

åœ¨ä½¿ç”¨æ—¶éœ€è¦å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°



```javascript
function* asyncFunction(args) {
  console.log(args);
  const res1 = yield new Promise(resolve => setTimeout(resolve, 1000, "yield1"));
  console.log(res1);
  const res2 = yield new Promise(resolve => setTimeout(resolve, 1000, "yield2"));
  console.log(res2);
  throw "return 3";
}

generatorToAsync(asyncFunction)("args").then(console.log, console.error);

```

å¦‚æ­¤æ‰§è¡Œåœ¨ asyncFunction å†…éƒ¨å°†é¡ºåºé—´éš”1s è¾“å‡º args, res1, res2ã€‚ä¸”ä¸ç”¨å…³å¿ƒä½•æ—¶è°ƒç”¨ç”Ÿæˆå™¨çš„ next æ–¹æ³•ï¼ŒåŒ…è£…æ–¹æ³•ä¸­ä¼šåœ¨ promise å®Œæˆçš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨next è§¦å‘ç”Ÿæˆå™¨çš„ç»§ç»­æ‰§è¡Œã€‚è¿™ä¹Ÿ async/await è¦å¹²çš„äº‹



-----



æ—©åœ¨2011å¹´ï¼Œè¿™æœ¬JavaScriptæƒå¨æŒ‡å—ä¸­å°±å·²ç»è®²äº†å„ç§æ–°æŠ€æœ¯äº†ï¼Œç”Ÿæˆå™¨ï¼Œæ•°ç»„çš„ forEach, filter, reduce ç­‰æ–¹æ³•ï¼ŒSSE,  Storage, Workerç­‰ï¼Œç„¶è€Œæˆ‘æ¸…æ™°çš„è®°å¾—ï¼Œå½“æ—¶è¿˜æ˜¯é¡¹ç›®ä¸­ç–¯ç‹‚ä½¿ç”¨jQuery, ä»¥åŠä¸€ä¸ªå«DWZçš„å¯Œå®¢ç«¯å¼€æºæ¡†æ¶ï¼Œè¿™äº›æ–°æŠ€æœ¯åŸºæœ¬éƒ½æ²¡ç”¨ä¸Šï¼Œå½“ç„¶å¯èƒ½æœ€ä¸»è¦çš„åŸå› å°±æ˜¯å½“å¹´è¦å…¼å®¹ IEğŸ˜…
